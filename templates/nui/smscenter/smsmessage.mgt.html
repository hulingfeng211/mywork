{% extends "../base.html" %}

{% block body %}
<div class="nui-toolbar" style="padding:2px;border-top:0;border-left:0;border-right: 0;">
    <table style="width: 100%">
        <tr>
            <td style="width:100%;">
                {#<a class="nui-button" iconCls="icon-add" plain="true" onclick="add_row()">新增</a>
                <a class="nui-button" iconCls="icon-remove" plain="true" onclick="remove_row()">删除</a> #}

            </td>
            <td style="white-space:nowrap;">
                <input id="key" class="nui-textbox" emptyText="手机号码或短信内容" style="width:150px;"
                       onenter="onKeyEnter"/>
                <a class="nui-button" onclick="search()">查询</a>
            </td>
        </tr>
    </table>
</div>
<div class="nui-fit">

    <div id="message_grid" class="nui-datagrid" borderStyle="border:0"
         showColumnsMenu="true"
         idField="id"
         url='{{ reverse_url("s.message.list") }}'
         idField="id"
         pageSize=20
         editNextOnEnterKey="true"
         ajaxOptions='{type:"get"}'
         {#oncellbeginedit="OnCellBeginEdit"
         oncellendedit="onCellEndEdit" #}
         style="width:100%;height:100%;">
        <div property="columns">

            <div field="message.mobile" vtype="minLength:6" width="120" headerAlign="center" allowSort="true">手机号
            </div>
            <div field="message.content" width="100" allowSort="true">短信内容
            </div>
            <div field="sendid"  allowSort="true">发送编号
            </div>
            <div field="message.extno" width="100" allowSort="true">扩展编号
            </div>


            <div field="msg" required="true" vtype="email" width="100" allowSort="true" align="left"
                 headerAlign="center">状态
            </div>


        </div>


    </div>
</div>
{%end%}
{%block script %}
<script type="text/javascript">
    var netType = [{id: 1, text: '内网'}, {id: 2, text: '外网'}];
    var osType = [{id: 1, text: 'window2003'},
        {id: 2, text: 'window2008 r2 x64'},
        {id: 3, text: 'window2012 r2'},
        {id: 4, text: 'Linux/Unix'}];
    var message_grid = nui.get('message_grid');
    $(function () {
        message_grid.load({s:'{"_id":-1}'});
       /* message_grid.on('load', function (e) {
            //todo
            e.cancel = true;
        });*/
    });


    function add_row() {
        var newRow = {
            ipaddr: '127.0.0.1',
            is_domain: 1

        };
        message_grid.addRow(newRow, 0);

    }
    function onKeyEnter() {
        search();
    }
    function search() {
        var key = nui.get('key').getValue();
        var q = {
            $or: [{
                "message.mobile": {
                    $regex: key
                }
            }, {
                "message.content": {
                    $regex: key
                }
            }]

        };
        message_grid.load({q: nui.encode(q),s:'{"_id":-1}'});

    }
    function remove_row() {
        var rows = server_grid.getSelecteds();
        if (rows.length > 0) {
            message_grid.removeRows(rows, true);
        }

    }
    function save_server_data() {
        var data = message_grid.getChanges();
        var json = nui.encode(data);
        var msgid = message_grid.loading("保存中，请稍后......");
        $.ajax({
            url: "{{ reverse_url('s.servers') }}",
            data: {data: json, '_xsrf': nui.Cookie.get('_xsrf')},
            //contentType:'application/json',
            type: "post",
            success: function (text) {
                //nui.hideMessageBox(msgid);
                message_grid.unmask();
                message_grid.reload();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText);
            }
        });
    }
</script>
{%end%}