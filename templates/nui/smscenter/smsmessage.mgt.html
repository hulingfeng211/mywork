{% extends "../base.html" %}

{% block body %}
<div class="nui-toolbar" style="padding:2px;border-top:0;border-left:0;border-right: 0;">
    <table style="width: 100%">
        <tr>
            <td style="width: 100%;">
                {#<a class="nui-button" iconCls="icon-add" plain="true" onclick="add_row()">新增</a>
                <a class="nui-button" iconCls="icon-remove" plain="true" onclick="remove_row()">删除</a> #}


                <label for="start_dt">开始日期:</label>
                <input id="start_dt" class="mini-datepicker" value="2010-01-01"/>
                <label for="end_dt">结束日期:</label>
                <input id="end_dt" class="mini-datepicker" value="2010-01-01"/>
                <div id="supplier" class="mini-radiobuttonlist" repeatItems="6" repeatLayout="table"
                     repeatDirection="horizontal"
                     textField="text" valuechanged="on_supplier_changed" valueField="id" value="all">
                </div>
            </td>
            <td style="white-space:nowrap;">
                <input id="key" class="nui-textbox" emptyText="手机号码或短信内容" style="width:150px;"
                       onenter="onKeyEnter"/>
                <a class="nui-button" onclick="search()">查询</a>
            </td>
        </tr>
    </table>
</div>
<div class="nui-fit">

    <div id="message_grid" class="nui-datagrid" borderStyle="border:0"
         showColumnsMenu="true"
         idField="id"
         url='{{ reverse_url("s.message.list") }}'
         idField="id"
         pageSize=20
         editNextOnEnterKey="true"
         ajaxOptions='{type:"get"}'
         {#oncellbeginedit="OnCellBeginEdit"
         oncellendedit="onCellEndEdit" #}
         style="width:100%;height:100%;">
        <div property="columns">

            <div field="message.mobile" vtype="minLength:6" width="120" headerAlign="center" allowSort="true">手机号
            </div>
            <div field="message.content" width="100" allowSort="true">短信内容
            </div>
            <div field="sendid" allowSort="true">发送编号
            </div>
            <div field="time" allowSort="true">发送时间
            </div>
            <div field="message.extno" width="100" allowSort="true">扩展编号
            </div>


            <div field="msg" required="true" vtype="email" width="100" allowSort="true" align="left"
                 headerAlign="center">状态
            </div>


        </div>


    </div>
</div>
{%end%}
{%block script %}
<script type="text/javascript">

    var sms_supplier_array = [{
        id: 'all', text: '全部'
    }, {
        id: 'chanzor', text: '畅卓科技'
    }, {
        id: '1xinxi', text: '第翼信息'
    }];
    var chanzor_columns = [
        {field: "message.mobile", width: 100, headerAlign: "center", allowSort: true, header: "手机号"},
        {field: "message.content", width: 400, headerAlign: "center", allowSort: true, header: "短信内容"},
        {field: "time", width: 100, headerAlign: "center", allowSort: true, header: "发送时间"},
        {field: "message.extno", width: 100, headerAlign: "center", allowSort: true, header: "扩展编号"},
    ];
    var exinxi_columns = [
        {field: "message.mobile", width: 100, headerAlign: "center", allowSort: true, header: "手机号"},
        {field: "message.content", width: 400, headerAlign: "center", allowSort: true, header: "短信内容"},
        {field: "sendid", width: 100, headerAlign: "center", allowSort: true, header: "发送编号"},
        {field: "message.extno", width: 100, headerAlign: "center", allowSort: true, header: "扩展码"},
    ];
    var message_grid = nui.get('message_grid');
    var supplier = nui.get('supplier');

    $(function () {
        message_grid.load({s: '{"_id":-1}'});
        supplier.loadData(sms_supplier_array);
        supplier.on("valuechanged", function (e) {
            var current_supplier = this.getValue();
            if (current_supplier == 'chanzor') {

                message_grid.set({columns: chanzor_columns});
                //message_grid.load({})
                var q = {
                    sendid: {$exists: false}
                };
                message_grid.load({q: nui.encode(q), s: '{"_id":-1}'});
            }
            else if (current_supplier == '1xinxi') {
                message_grid.set({columns: exinxi_columns});
                var q = {
                    sendid: {$exists: true}
                };
                message_grid.load({q: nui.encode(q), s: '{"_id":-1}'});

            }
            else {
                message_grid.load({});
            }
        });
        /* message_grid.on('load', function (e) {
         //todo
         e.cancel = true;
         });*/
    });
    function on_supplier_changed(e) {
        console.info(e);

    }

    function onKeyEnter() {
        search();
    }
    function search() {
        var key = nui.get('key').getValue();
        var q = {
            $or: [{
                "message.mobile": {
                    $regex: key
                }
            }, {
                "message.content": {
                    $regex: key
                }
            }]

        };
        message_grid.load({q: nui.encode(q), s: '{"_id":-1}'});

    }

</script>
{%end%}